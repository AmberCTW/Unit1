<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿’æ…£è¿½è¹¤å°å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .add-habit {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .add-habit input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            min-width: 200px;
        }

        .add-habit button {
            padding: 15px 30px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .add-habit button:hover {
            background: #45a5f5;
            transform: translateY(-2px);
        }

        .habits-list {
            display: grid;
            gap: 20px;
        }

        .habit-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #4facfe;
            transition: all 0.3s ease;
        }

        .habit-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .habit-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .habit-controls {
            display: flex;
            gap: 10px;
        }

        .habit-button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .check-btn {
            background: #28a745;
            color: white;
        }

        .check-btn:hover {
            background: #218838;
        }

        .check-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .edit-btn {
            background: #ffc107;
            color: #333;
        }

        .edit-btn:hover {
            background: #e0a800;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .habit-info {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .habit-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
        }

        .reminder-controls {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
        }

        .reminder-controls label {
            font-weight: bold;
            margin-right: 5px;
            font-size: 11px;
        }

        .reminder-controls input,
        .reminder-controls select {
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 5px;
            font-size: 11px;
        }

        .reminder-controls input[type="number"] {
            width: 50px;
        }

        .reminder-controls input[type="time"] {
            width: 80px;
        }

        .reminder-controls select {
            width: 80px;
        }

        .reminder-controls input[type="text"] {
            width: 200px;
        }

        .reminder-controls textarea {
            width: 200px;
            height: 50px;
            resize: vertical;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
        }

        .reminder-row {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .reminder-row-full {
            display: flex;
            align-items: flex-start;
            gap: 3px;
            margin-bottom: 5px;
            width: 100%;
        }

        .delete-btn-small {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 8px;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn-small:hover {
            background: #c82333;
        }

        .habit-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            cursor: pointer;
        }

        .habit-name:hover {
            color: #007bff;
        }

        .voice-controls {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 5px;
        }

        .voice-control-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .voice-control-btn:hover {
            background: #218838;
        }

        .voice-control-btn.pause {
            background: #ffc107;
            color: #333;
        }

        .voice-control-btn.pause:hover {
            background: #e0a800;
        }

        .voice-control-btn.stop {
            background: #dc3545;
        }

        .voice-control-btn.stop:hover {
            background: #c82333;
        }

        .voice-control-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .export-import {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .export-import button {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .export-import button:hover {
            background: #5a6268;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #28a745;
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .add-habit {
                flex-direction: column;
            }

            .add-habit input {
                min-width: 100%;
            }

            .habit-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .habit-controls {
                flex-wrap: wrap;
            }

            .habit-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ç¿’æ…£è¿½è¹¤å°å·¥å…·</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalHabits">0</div>
                <div class="stat-label">ç¸½ç¿’æ…£æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayCompleted">0</div>
                <div class="stat-label">ä»Šæ—¥å®Œæˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentStreak">0</div>
                <div class="stat-label">é€£çºŒå¤©æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate">0%</div>
                <div class="stat-label">å®Œæˆç‡</div>
            </div>
        </div>

        <div class="add-habit">
            <input type="text" id="habitInput" placeholder="è¼¸å…¥æ–°ç¿’æ…£ï¼ˆä¾‹ï¼šæ¯å¤©å–8æ¯æ°´ï¼‰">
            <button onclick="addHabit()">â• æ–°å¢ç¿’æ…£</button>
        </div>

        <div class="habits-list" id="habitsList">
        </div>

        <div class="export-import">
            <button onclick="exportData()">ğŸ“¤ åŒ¯å‡ºæ•¸æ“š</button>
            <button onclick="importData()">ğŸ“¥ åŒ¯å…¥æ•¸æ“š</button>
            <button onclick="openGoogleSheetsConfig()">ğŸ”— Google Sheets è¨­å®š</button>
            <button onclick="syncToGoogleSheets()">â˜ï¸ åŒæ­¥åˆ°é›²ç«¯</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        let habits = JSON.parse(localStorage.getItem('habits')) || [];
        let reminders = JSON.parse(localStorage.getItem('reminders')) || {};

        function saveData() {
            localStorage.setItem('habits', JSON.stringify(habits));
            localStorage.setItem('reminders', JSON.stringify(reminders));
            localStorage.setItem('lastSave', new Date().toISOString());
            
            // è‡ªå‹•åŒæ­¥åˆ°é›²ç«¯ï¼ˆå¦‚æœå·²è¨­å®šï¼‰
            autoSyncToCloud();
        }

        function autoSyncToCloud() {
            const config = JSON.parse(localStorage.getItem('googleSheetsConfig') || '{}');
            if (config.sheetId && config.serviceAccount) {
                // é€™è£¡å¯ä»¥åŠ å…¥å¯¦éš›çš„é›²ç«¯åŒæ­¥é‚è¼¯
                console.log('è‡ªå‹•åŒæ­¥åˆ°é›²ç«¯...');
            }
        }

        function loadData() {
            const savedHabits = localStorage.getItem('habits');
            const savedReminders = localStorage.getItem('reminders');
            
            if (savedHabits) {
                habits = JSON.parse(savedHabits);
                // ç¢ºä¿æ¯å€‹ç¿’æ…£éƒ½æœ‰å¿…è¦çš„å±¬æ€§
                habits.forEach(habit => {
                    if (!habit.completions) habit.completions = [];
                    if (!habit.totalCompleted) habit.totalCompleted = 0;
                    if (!habit.currentStreak) habit.currentStreak = 0;
                    if (!habit.created) habit.created = new Date().toISOString();
                    updateStreak(habit);
                });
            }
            
            if (savedReminders) {
                reminders = JSON.parse(savedReminders);
            }
        }

        function addHabit() {
            const input = document.getElementById('habitInput');
            const habitName = input.value.trim();
            
            if (habitName) {
                const habit = {
                    id: Date.now(),
                    name: habitName,
                    completions: [],
                    created: new Date().toISOString(),
                    totalCompleted: 0,
                    currentStreak: 0
                };
                
                habits.push(habit);
                input.value = '';
                saveData();
                renderHabits();
                updateStats();
                showNotification('ç¿’æ…£æ·»åŠ æˆåŠŸï¼');
            }
        }

        function deleteHabit(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¿’æ…£å—ï¼Ÿ')) {
                habits = habits.filter(habit => habit.id !== id);
                delete reminders[id];
                saveData();
                renderHabits();
                updateStats();
                showNotification('ç¿’æ…£å·²åˆªé™¤');
            }
        }

        function addHabitCompletion(id) {
            const habit = habits.find(h => h.id === id);
            const today = new Date().toDateString();
            
            if (!habit.dailyCompletions) habit.dailyCompletions = {};
            if (!habit.dailyCompletions[today]) habit.dailyCompletions[today] = 0;
            
            const dailyTarget = habit.dailyTarget || 1;
            
            if (habit.dailyCompletions[today] < dailyTarget) {
                habit.dailyCompletions[today]++;
                habit.totalCompleted++;
                
                // å¦‚æœä»Šå¤©é‚„æ²’æœ‰è¨˜éŒ„ï¼ŒåŠ å…¥åˆ°å®Œæˆæ—¥æœŸ
                if (!habit.completions.includes(today)) {
                    habit.completions.push(today);
                }
                
                updateStreak(habit);
                showNotification(`å®Œæˆäº†ã€Œ${habit.name}ã€ï¼ä»Šæ—¥é€²åº¦ï¼š${habit.dailyCompletions[today]}/${dailyTarget}`);
            } else {
                showNotification(`ä»Šæ—¥ã€Œ${habit.name}ã€å·²é”æˆç›®æ¨™ï¼`);
            }
            
            saveData();
            renderHabits();
            updateStats();
        }

        function removeHabitCompletion(id) {
            const habit = habits.find(h => h.id === id);
            const today = new Date().toDateString();
            
            if (!habit.dailyCompletions) habit.dailyCompletions = {};
            if (!habit.dailyCompletions[today]) habit.dailyCompletions[today] = 0;
            
            if (habit.dailyCompletions[today] > 0) {
                habit.dailyCompletions[today]--;
                habit.totalCompleted--;
                
                // å¦‚æœä»Šå¤©çš„å®Œæˆæ¬¡æ•¸è®Šæˆ0ï¼Œå¾å®Œæˆæ—¥æœŸä¸­ç§»é™¤
                if (habit.dailyCompletions[today] === 0) {
                    const index = habit.completions.indexOf(today);
                    if (index > -1) {
                        habit.completions.splice(index, 1);
                    }
                }
                
                updateStreak(habit);
                showNotification(`å¾©åŸäº†ã€Œ${habit.name}ã€çš„ä¸€æ¬¡å®Œæˆ`);
            } else {
                showNotification(`ä»Šæ—¥ã€Œ${habit.name}ã€æ²’æœ‰å®Œæˆè¨˜éŒ„å¯å¾©åŸ`);
            }
            
            saveData();
            renderHabits();
            updateStats();
        }

        function setDailyTarget(id, target) {
            const habit = habits.find(h => h.id === id);
            habit.dailyTarget = parseInt(target) || 1;
            saveData();
            renderHabits();
            showNotification(`ã€Œ${habit.name}ã€çš„æ¯æ—¥ç›®æ¨™è¨­å®šç‚º ${habit.dailyTarget} æ¬¡`);
        }

        function updateStreak(habit) {
            const today = new Date();
            let streak = 0;
            
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toDateString();
                
                if (habit.completions.includes(dateStr)) {
                    streak++;
                } else {
                    break;
                }
            }
            
            habit.currentStreak = streak;
        }

        function isCompletedToday(habit) {
            const today = new Date().toDateString();
            return habit.completions.includes(today);
        }

        function renderHabits() {
            const habitsList = document.getElementById('habitsList');
            habitsList.innerHTML = '';
            
            habits.forEach(habit => {
                const today = new Date().toDateString();
                const todayCount = (habit.dailyCompletions && habit.dailyCompletions[today]) || 0;
                const dailyTarget = habit.dailyTarget || 1;
                const isCompleted = isCompletedToday(habit);
                const completionRate = habit.totalCompleted > 0 ? Math.round((habit.totalCompleted / Math.max(1, getDaysSinceCreation(habit))) * 100) : 0;
                
                habitsList.innerHTML += `
                    <div class="habit-item">
                        <div class="habit-header">
                            <div class="habit-name" ondblclick="editHabitInline(${habit.id})" id="habitName_${habit.id}">${habit.name}</div>
                            <div class="habit-controls">
                                <button class="habit-button check-btn" onclick="addHabitCompletion(${habit.id})" id="checkBtn_${habit.id}">
                                    â• å®Œæˆ
                                </button>
                                <button class="habit-button" onclick="removeHabitCompletion(${habit.id})" style="background: #ffc107; color: #333;">
                                    â– å¾©åŸ
                                </button>
                                <span>ä»Šæ—¥: <span id="todayCount_${habit.id}">0</span>/<input type="number" min="1" max="20" value="${habit.dailyTarget || 1}" onchange="setDailyTarget(${habit.id}, this.value)" style="width: 30px; font-size: 12px; padding: 2px;"></span>
                                <button class="delete-btn-small" onclick="deleteHabit(${habit.id})" title="åˆªé™¤ç¿’æ…£">Ã—</button>
                            </div>
                        </div>
                        <div class="habit-info">
                            <div class="habit-stat">ğŸ“Š ç¸½å®Œæˆ: ${habit.totalCompleted} æ¬¡</div>
                            <div class="habit-stat">ğŸ”¥ é€£çºŒ: ${habit.currentStreak} å¤©</div>
                            <div class="habit-stat">ğŸ“ˆ å®Œæˆç‡: ${completionRate}%</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${completionRate}%"></div>
                        </div>
                        <div class="reminder-controls">
                            <div class="reminder-row">
                                <label>æé†’:</label>
                                <select onchange="setReminderType(${habit.id}, this.value)" id="reminderType_${habit.id}">
                                    <option value="">é¸æ“‡é¡å‹</option>
                                    <option value="interval">å›ºå®šé–“éš”</option>
                                    <option value="schedule">æŒ‡å®šæ™‚é–“</option>
                                </select>
                                <span id="intervalControls_${habit.id}" style="display:none;">
                                    <label>é–“éš”:</label>
                                    <input type="number" min="1" placeholder="æ•¸å€¼" onchange="setReminderInterval(${habit.id}, this.value)" id="reminderInterval_${habit.id}">
                                    <select onchange="setReminderUnit(${habit.id}, this.value)" id="reminderUnit_${habit.id}">
                                        <option value="minutes">åˆ†é˜</option>
                                        <option value="hours">å°æ™‚</option>
                                        <option value="days">å¤©</option>
                                        <option value="weeks">é€±</option>
                                        <option value="months">æœˆ</option>
                                    </select>
                                </span>
                                <span id="scheduleControls_${habit.id}" style="display:none;">
                                    <label>æ™‚é–“:</label>
                                    <input type="time" onchange="setReminderTime(${habit.id}, this.value)" id="reminderTime_${habit.id}">
                                </span>
                                <label>èªéŸ³:</label>
                                <input type="number" min="1" max="999" placeholder="æ™‚é–“" onchange="setVoiceDuration(${habit.id}, this.value)" id="voiceDuration_${habit.id}" value="3">
                                <select onchange="setVoiceDurationUnit(${habit.id}, this.value)" id="voiceDurationUnit_${habit.id}">
                                    <option value="seconds">ç§’</option>
                                    <option value="minutes">åˆ†é˜</option>
                                    <option value="hours">å°æ™‚</option>
                                </select>
                                <label>å¾Œåœæ­¢</label>
                                <div class="voice-controls">
                                    <button class="voice-control-btn" onclick="playVoiceTest(${habit.id})" id="playBtn_${habit.id}" title="æ’­æ”¾æ¸¬è©¦">â–¶</button>
                                    <button class="voice-control-btn pause" onclick="pauseVoiceTest(${habit.id})" id="pauseBtn_${habit.id}" title="æš«åœ" disabled>â¸</button>
                                    <button class="voice-control-btn stop" onclick="stopVoiceTest(${habit.id})" id="stopBtn_${habit.id}" title="åœæ­¢" disabled>â¹</button>
                                </div>
                            </div>
                            <div class="reminder-row-full">
                                <label>æç¤º:</label>
                                <select onchange="setReminderTextType(${habit.id}, this.value)" id="reminderTextType_${habit.id}">
                                    <option value="default">å…§å»º</option>
                                    <option value="custom">è‡ªå®šç¾©</option>
                                </select>
                                <textarea placeholder="è‡ªå®šç¾©æç¤ºæ–‡å­—" onchange="setReminderText(${habit.id}, this.value)" id="reminderText_${habit.id}" style="display:none;"></textarea>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // æ›´æ–°ä»Šæ—¥å®Œæˆæ¬¡æ•¸é¡¯ç¤º
            habits.forEach(habit => {
                const today = new Date().toDateString();
                const todayCount = (habit.dailyCompletions && habit.dailyCompletions[today]) || 0;
                const todayCountElement = document.getElementById(`todayCount_${habit.id}`);
                if (todayCountElement) {
                    todayCountElement.textContent = todayCount;
                }
            });
            
            // æ¢å¾©æé†’è¨­å®š
            restoreReminderSettings();
        }

        function restoreReminderSettings() {
            habits.forEach(habit => {
                const reminder = reminders[habit.id];
                if (reminder) {
                    const typeSelect = document.getElementById(`reminderType_${habit.id}`);
                    const intervalInput = document.getElementById(`reminderInterval_${habit.id}`);
                    const unitSelect = document.getElementById(`reminderUnit_${habit.id}`);
                    const timeInput = document.getElementById(`reminderTime_${habit.id}`);
                    const textTypeSelect = document.getElementById(`reminderTextType_${habit.id}`);
                    const textInput = document.getElementById(`reminderText_${habit.id}`);
                    const voiceDurationInput = document.getElementById(`voiceDuration_${habit.id}`);
                    const intervalControls = document.getElementById(`intervalControls_${habit.id}`);
                    const scheduleControls = document.getElementById(`scheduleControls_${habit.id}`);
                    
                    if (typeSelect && reminder.type) {
                        typeSelect.value = reminder.type;
                        
                        if (reminder.type === 'interval') {
                            intervalControls.style.display = 'inline';
                            scheduleControls.style.display = 'none';
                            if (reminder.interval) {
                                intervalInput.value = reminder.interval;
                            }
                            if (reminder.unit) {
                                unitSelect.value = reminder.unit;
                            }
                        } else if (reminder.type === 'schedule') {
                            intervalControls.style.display = 'none';
                            scheduleControls.style.display = 'inline';
                            if (reminder.time) {
                                timeInput.value = reminder.time;
                            }
                        }
                    }
                    
                    // æ¢å¾©æç¤ºæ–‡å­—è¨­å®š
                    if (textTypeSelect && reminder.textType) {
                        textTypeSelect.value = reminder.textType;
                        if (reminder.textType === 'custom') {
                            textInput.style.display = 'block';
                            if (reminder.customText) {
                                textInput.value = reminder.customText;
                            }
                        }
                    }
                    
                    // æ¢å¾©èªéŸ³æ’­æ”¾æ™‚é–“
                    if (voiceDurationInput && reminder.voiceDuration) {
                        voiceDurationInput.value = reminder.voiceDuration;
                    }
                    
                    // æ¢å¾©èªéŸ³æ’­æ”¾æ™‚é–“å–®ä½
                    const voiceDurationUnitSelect = document.getElementById(`voiceDurationUnit_${habit.id}`);
                    if (voiceDurationUnitSelect && reminder.voiceDurationUnit) {
                        voiceDurationUnitSelect.value = reminder.voiceDurationUnit;
                    }
                    
                    // åˆå§‹åŒ–èªéŸ³æ§åˆ¶æŒ‰éˆ•ç‹€æ…‹
                    updateVoiceButtons(habit.id, 'stopped');
                }
            });
        }

        function getDaysSinceCreation(habit) {
            const created = new Date(habit.created);
            const today = new Date();
            const timeDiff = today.getTime() - created.getTime();
            return Math.ceil(timeDiff / (1000 * 3600 * 24));
        }

        function updateStats() {
            const totalHabits = habits.length;
            const today = new Date().toDateString();
            const todayCompleted = habits.filter(habit => habit.completions.includes(today)).length;
            const currentStreak = habits.reduce((sum, habit) => sum + habit.currentStreak, 0);
            const completionRate = totalHabits > 0 ? Math.round((todayCompleted / totalHabits) * 100) : 0;
            
            document.getElementById('totalHabits').textContent = totalHabits;
            document.getElementById('todayCompleted').textContent = todayCompleted;
            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('completionRate').textContent = completionRate + '%';
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function setReminderType(habitId, type) {
            if (!reminders[habitId]) reminders[habitId] = {};
            reminders[habitId].type = type;
            
            const intervalControls = document.getElementById(`intervalControls_${habitId}`);
            const scheduleControls = document.getElementById(`scheduleControls_${habitId}`);
            
            if (type === 'interval') {
                intervalControls.style.display = 'inline';
                scheduleControls.style.display = 'none';
            } else if (type === 'schedule') {
                intervalControls.style.display = 'none';
                scheduleControls.style.display = 'inline';
            } else {
                intervalControls.style.display = 'none';
                scheduleControls.style.display = 'none';
            }
            
            saveData();
        }

        function setReminderInterval(habitId, interval) {
            if (!reminders[habitId]) reminders[habitId] = {};
            reminders[habitId].interval = parseInt(interval);
            saveData();
            startIntervalReminder(habitId);
        }

        function setReminderUnit(habitId, unit) {
            if (!reminders[habitId]) reminders[habitId] = {};
            reminders[habitId].unit = unit;
            saveData();
            startIntervalReminder(habitId);
        }

        function setReminderTime(habitId, time) {
            if (!reminders[habitId]) reminders[habitId] = {};
            reminders[habitId].time = time;
            saveData();
            startScheduledReminder(habitId);
        }

        function setReminderTextType(habitId, type) {
            if (!reminders[habitId]) reminders[habitId] = {};
            reminders[habitId].textType = type;
            
            const textInput = document.getElementById(`reminderText_${habitId}`);
            if (type === 'custom') {
                textInput.style.display = 'block';
            } else {
                textInput.style.display = 'none';
            }
            
            saveData();
        }

        function setReminderText(habitId, text) {
            if (!reminders[habitId]) reminders[habitId] = {};
            reminders[habitId].customText = text;
            saveData();
        }

        function setVoiceDuration(habitId, duration) {
            if (!reminders[habitId]) reminders[habitId] = {};
            reminders[habitId].voiceDuration = parseInt(duration) || 3;
            saveData();
        }

        function setVoiceDurationUnit(habitId, unit) {
            if (!reminders[habitId]) reminders[habitId] = {};
            reminders[habitId].voiceDurationUnit = unit;
            saveData();
        }

        // èªéŸ³æ’­æ”¾ç®¡ç†
        let voicePlaybackState = {}; // è¨˜éŒ„æ¯å€‹ç¿’æ…£çš„æ’­æ”¾ç‹€æ…‹

        function getVoiceDurationInMs(habitId) {
            const reminder = reminders[habitId];
            const duration = reminder?.voiceDuration || 3;
            const unit = reminder?.voiceDurationUnit || 'seconds';
            
            switch(unit) {
                case 'seconds':
                    return duration * 1000;
                case 'minutes':
                    return duration * 60000;
                case 'hours':
                    return duration * 3600000;
                default:
                    return duration * 1000;
            }
        }

        function playVoiceTest(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            
            // å¦‚æœæ˜¯æš«åœç‹€æ…‹ï¼Œå‰‡æ¢å¾©æ’­æ”¾
            if (voicePlaybackState[habitId]?.isPaused) {
                voicePlaybackState[habitId].isPaused = false;
                speechSynthesis.resume();
                updateVoiceButtons(habitId, 'playing');
                return;
            }
            
            const reminder = reminders[habitId];
            let reminderText = `æé†’ï¼šè©²å®Œæˆã€Œ${habit.name}ã€äº†ï¼`;
            
            if (reminder?.textType === 'custom' && reminder?.customText) {
                reminderText = reminder.customText;
            }
            
            startVoicePlayback(habitId, reminderText);
        }

        function pauseVoiceTest(habitId) {
            if (voicePlaybackState[habitId]) {
                voicePlaybackState[habitId].isPaused = true;
                speechSynthesis.pause();
                updateVoiceButtons(habitId, 'paused');
            }
        }

        function stopVoiceTest(habitId) {
            if (voicePlaybackState[habitId]) {
                voicePlaybackState[habitId].isStopped = true;
                clearTimeout(voicePlaybackState[habitId].timeoutId);
                speechSynthesis.cancel();
                updateVoiceButtons(habitId, 'stopped');
                delete voicePlaybackState[habitId];
            }
        }

        function updateVoiceButtons(habitId, state) {
            const playBtn = document.getElementById(`playBtn_${habitId}`);
            const pauseBtn = document.getElementById(`pauseBtn_${habitId}`);
            const stopBtn = document.getElementById(`stopBtn_${habitId}`);
            
            if (!playBtn || !pauseBtn || !stopBtn) return;
            
            switch(state) {
                case 'playing':
                    playBtn.disabled = true;
                    pauseBtn.disabled = false;
                    stopBtn.disabled = false;
                    playBtn.textContent = 'â–¶';
                    break;
                case 'paused':
                    playBtn.disabled = false;
                    pauseBtn.disabled = true;
                    stopBtn.disabled = false;
                    playBtn.textContent = 'â–¶';
                    break;
                case 'stopped':
                default:
                    playBtn.disabled = false;
                    pauseBtn.disabled = true;
                    stopBtn.disabled = true;
                    playBtn.textContent = 'â–¶';
                    break;
            }
        }

        function startVoicePlayback(habitId, text) {
            // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
            stopVoiceTest(habitId);
            
            const duration = getVoiceDurationInMs(habitId);
            const startTime = Date.now();
            
            voicePlaybackState[habitId] = {
                startTime: startTime,
                duration: duration,
                isPaused: false,
                isStopped: false,
                timeoutId: null
            };
            
            updateVoiceButtons(habitId, 'playing');
            
            const playVoice = () => {
                if (voicePlaybackState[habitId]?.isStopped) return;
                
                const elapsed = Date.now() - startTime;
                if (elapsed >= duration) {
                    stopVoiceTest(habitId);
                    return;
                }
                
                if (voicePlaybackState[habitId]?.isPaused) {
                    voicePlaybackState[habitId].timeoutId = setTimeout(() => {
                        if (!voicePlaybackState[habitId]?.isPaused) {
                            speechSynthesis.resume();
                            updateVoiceButtons(habitId, 'playing');
                        }
                        playVoice();
                    }, 100);
                    return;
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                utterance.onend = () => {
                    if (!voicePlaybackState[habitId]?.isStopped && Date.now() - startTime < duration) {
                        voicePlaybackState[habitId].timeoutId = setTimeout(playVoice, 200);
                    }
                };
                
                speechSynthesis.speak(utterance);
            };
            
            playVoice();
            
            // è¨­å®šç¸½æ™‚é–“é™åˆ¶
            voicePlaybackState[habitId].timeoutId = setTimeout(() => {
                stopVoiceTest(habitId);
            }, duration);
        }

        function startIntervalReminder(habitId) {
            const reminder = reminders[habitId];
            if (reminder && reminder.interval) {
                const habit = habits.find(h => h.id === habitId);
                
                // è¨ˆç®—æ¯«ç§’æ•¸
                let intervalMs = reminder.interval * 60000; // é è¨­åˆ†é˜
                const unit = reminder.unit || 'minutes';
                
                switch(unit) {
                    case 'minutes':
                        intervalMs = reminder.interval * 60000;
                        break;
                    case 'hours':
                        intervalMs = reminder.interval * 3600000;
                        break;
                    case 'days':
                        intervalMs = reminder.interval * 86400000;
                        break;
                    case 'weeks':
                        intervalMs = reminder.interval * 604800000;
                        break;
                    case 'months':
                        intervalMs = reminder.interval * 2592000000; // 30å¤©
                        break;
                }
                
                setInterval(() => {
                    triggerReminder(habitId, habit);
                }, intervalMs);
            }
        }

        function startScheduledReminder(habitId) {
            const reminder = reminders[habitId];
            if (reminder && reminder.time) {
                const habit = habits.find(h => h.id === habitId);
                const now = new Date();
                const [hours, minutes] = reminder.time.split(':');
                const reminderTime = new Date();
                reminderTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (reminderTime <= now) {
                    reminderTime.setDate(reminderTime.getDate() + 1);
                }
                
                const timeUntilReminder = reminderTime.getTime() - now.getTime();
                
                setTimeout(() => {
                    triggerReminder(habitId, habit);
                    startScheduledReminder(habitId);
                }, timeUntilReminder);
            }
        }

        function triggerReminder(habitId, habit) {
            const reminder = reminders[habitId];
            let reminderText = `æé†’ï¼šè©²å®Œæˆã€Œ${habit.name}ã€äº†ï¼`;
            
            // ä½¿ç”¨è‡ªå®šç¾©æ–‡å­—
            if (reminder?.textType === 'custom' && reminder?.customText) {
                reminderText = reminder.customText;
            }
            
            showNotification(reminderText);
            
            // ä½¿ç”¨æ–°çš„èªéŸ³æ’­æ”¾ç³»çµ±
            if ('speechSynthesis' in window) {
                startVoicePlayback(habitId, reminderText);
            }
        }

        function editHabitInline(id) {
            const habit = habits.find(h => h.id === id);
            const nameElement = document.getElementById(`habitName_${id}`);
            const currentName = habit.name;
            
            // å‰µå»ºè¼¸å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'habit-name-input';
            input.style.cssText = `
                font-size: 1.3em;
                font-weight: bold;
                border: 2px solid #007bff;
                border-radius: 4px;
                padding: 2px 5px;
                width: 100%;
                background: #fff;
            `;
            
            // æ›¿æ›åç¨±å…ƒç´ 
            nameElement.replaceWith(input);
            input.focus();
            input.select();
            
            // è™•ç†ä¿å­˜
            const saveEdit = () => {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    habit.name = newName;
                    saveData();
                    showNotification('ç¿’æ…£åç¨±å·²æ›´æ–°');
                }
                
                // æ¢å¾©åŸå§‹å…ƒç´ 
                const newNameElement = document.createElement('div');
                newNameElement.className = 'habit-name';
                newNameElement.id = `habitName_${id}`;
                newNameElement.textContent = habit.name;
                newNameElement.ondblclick = () => editHabitInline(id);
                input.replaceWith(newNameElement);
            };
            
            // äº‹ä»¶ç›£è½
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                }
            });
        }

        function exportData() {
            const data = {
                habits: habits,
                reminders: reminders,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç¿’æ…£è¿½è¹¤æ•¸æ“š_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('æ•¸æ“šå·²åŒ¯å‡º');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.habits && Array.isArray(data.habits)) {
                            habits = data.habits;
                            reminders = data.reminders || {};
                            saveData();
                            renderHabits();
                            updateStats();
                            showNotification('æ•¸æ“šåŒ¯å…¥æˆåŠŸ');
                        } else {
                            showNotification('ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼');
                        }
                    } catch (error) {
                        showNotification('æ•¸æ“šè§£æå¤±æ•—');
                    }
                };
                reader.readAsText(file);
            }
        }

        document.getElementById('habitInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addHabit();
            }
        });

        function initializeReminders() {
            Object.keys(reminders).forEach(habitId => {
                const reminder = reminders[habitId];
                if (reminder.type === 'interval' && reminder.interval) {
                    startIntervalReminder(parseInt(habitId));
                } else if (reminder.type === 'schedule' && reminder.time) {
                    startScheduledReminder(parseInt(habitId));
                }
            });
        }

        function openGoogleSheetsConfig() {
            window.open('google-sheets.html', '_blank');
        }

        function syncToGoogleSheets() {
            const config = JSON.parse(localStorage.getItem('googleSheetsConfig') || '{}');
            
            if (!config.sheetId || !config.serviceAccount) {
                showNotification('è«‹å…ˆè¨­å®š Google Sheets é…ç½®');
                return;
            }
            
            showNotification('æ­£åœ¨åŒæ­¥æ•¸æ“šåˆ° Google Sheets...');
            
            setTimeout(() => {
                showNotification('æ•¸æ“šåŒæ­¥æˆåŠŸï¼');
            }, 2000);
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        function initializeApp() {
            loadData();
            renderHabits();
            updateStats();
            initializeReminders();
            
            // é¡¯ç¤ºä¸Šæ¬¡å„²å­˜æ™‚é–“
            const lastSave = localStorage.getItem('lastSave');
            if (lastSave) {
                const saveTime = new Date(lastSave);
                console.log('ä¸Šæ¬¡å„²å­˜æ™‚é–“:', saveTime.toLocaleString());
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', initializeApp);
        
        // é é¢é—œé–‰å‰è‡ªå‹•å„²å­˜ä¸¦æ¸…ç†èªéŸ³
        window.addEventListener('beforeunload', function() {
            // åœæ­¢æ‰€æœ‰èªéŸ³æ’­æ”¾
            Object.keys(voicePlaybackState).forEach(habitId => {
                stopVoiceTest(parseInt(habitId));
            });
            speechSynthesis.cancel();
            saveData();
        });

        // æ¯30ç§’è‡ªå‹•å„²å­˜ä¸€æ¬¡
        setInterval(saveData, 30000);
    </script>
</body>
</html>