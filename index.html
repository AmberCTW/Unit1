<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šæ™‚ä¸¦é‡è¤‡æé†’æ¨¡çµ„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .reminder-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        #scheduleType {
            width: fit-content;
            max-width: 100px;
            min-width: 80px;
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .mode-btn:hover {
            border-color: #007bff;
        }
        
        .mode-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            flex: 1;
        }
        
        .mode-checkbox:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .mode-checkbox input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }
        
        .mode-checkbox .checkmark {
            font-weight: bold;
            color: #333;
        }
        
        .mode-checkbox input[type="checkbox"]:checked + .checkmark {
            color: #007bff;
        }

        .mode-config {
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .mode-config.active {
            display: block;
        }

        .interval-config {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .interval-config input {
            width: 80px;
        }

        .schedule-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .action-types {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-type {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-type.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .action-config {
            display: none;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .action-config.active {
            display: block;
        }

        .duration-config {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .duration-config input {
            width: 80px;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .action-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .action-checkbox:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .action-checkbox input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .action-checkbox .checkmark {
            font-weight: bold;
            color: #333;
        }

        .action-checkbox input[type="checkbox"]:checked + .checkmark {
            color: #007bff;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .checkbox-item:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        .checkbox-item input[type="checkbox"]:checked + span {
            color: #007bff;
            font-weight: bold;
        }

        .weekday-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-top: 10px;
        }

        .weekday-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .weekday-item input[type="checkbox"] {
            display: none;
        }

        .weekday-item span {
            width: 18px;
            height: 18px;
            border: 1px solid #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            color: #666;
            background: white;
            transition: all 0.3s ease;
        }

        .weekday-item:hover span {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .weekday-item input[type="checkbox"]:checked + span {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .month-day-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .month-day-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .month-day-input button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .month-day-input button:hover {
            background: #0056b3;
        }

        .selected-days {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .day-tag {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            color: #495057;
        }

        .day-tag .remove-day {
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
            font-size: 14px;
        }

        .day-tag .remove-day:hover {
            color: #c82333;
        }
        
        .time-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-range input[type="time"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .time-range span {
            color: #666;
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-stopped {
            background: #dc3545;
        }

        .status-running {
            background: #28a745;
        }

        .status-paused {
            background: #ffc107;
        }

        .log-area {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
            color: #666;
            font-size: 12px;
        }

        .log-entry.success {
            color: #28a745;
        }

        .log-entry.error {
            color: #dc3545;
        }


        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            font-size: 12px;
        }

        .file-item:hover {
            background: #e9ecef;
        }

        .file-name {
            color: #333;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .empty-list {
            color: #666;
            font-size: 12px;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 600px) {
            .interval-config,
            .duration-config,
            .control-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .mode-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â° å®šæ™‚ä¸¦é‡è¤‡æé†’æ¨¡çµ„</h1>
        
        <div class="reminder-card">
            <div class="form-group">
                <label>æé†’åç¨±</label>
                <input type="text" id="reminderName" placeholder="è¼¸å…¥æé†’åç¨±" value="æ¯æ—¥æé†’">
            </div>

            <!-- æ¨¡å¼é¸æ“‡ -->
            <h3>æé†’æ¨¡å¼ï¼ˆå¯è¤‡é¸ï¼‰</h3>
            <div class="mode-selector">
                <label class="mode-checkbox">
                    <input type="checkbox" id="intervalModeCheckbox" checked onchange="toggleMode('interval')">
                    <span class="checkmark">æ¨¡å¼ Aï¼šé–“éš”æé†’</span>
                </label>
                <label class="mode-checkbox">
                    <input type="checkbox" id="scheduleModeCheckbox" onchange="toggleMode('schedule')">
                    <span class="checkmark">æ¨¡å¼ Bï¼šæ’ç¨‹æé†’</span>
                </label>
            </div>

            <!-- æ¨¡å¼ Aï¼šé–“éš”æé†’è¨­å®š -->
            <div id="intervalConfig" class="mode-config active">
                <div class="form-group">
                    <label>é–“éš”è¨­å®š</label>
                    <div class="interval-config">
                        <span>æ¯</span>
                        <input type="number" id="intervalValue" min="1" value="30" onchange="handleSettingChange(event);" oninput="handleSettingChange(event);">
                        <select id="intervalUnit" onchange="handleSettingChange(event);">
                            <option value="minutes" selected>åˆ†é˜</option>
                            <option value="hours">å°æ™‚</option>
                            <option value="days">å¤©</option>
                            <option value="weeks">é€±</option>
                            <option value="months">æœˆ</option>
                        </select>
                        <span>åŸ·è¡Œä¸€æ¬¡</span>
                    </div>
                </div>
            </div>

            <!-- æ¨¡å¼ Bï¼šæ’ç¨‹æé†’è¨­å®š -->
            <div id="scheduleConfig" class="mode-config">
                <div class="schedule-config">
                    <div class="form-group">
                        <label>æ’ç¨‹é¡å‹</label>
                        <select id="scheduleType" onchange="updateScheduleConfig(); handleSettingChange(event);">
                            <option value="weekly">æ¯é€±</option>
                            <option value="monthly">æ¯æœˆ</option>
                            <option value="daily">æ¯å¤©</option>
                        </select>
                    </div>
                    <div class="form-group" id="weeklyConfig">
                        <label>æ˜ŸæœŸ</label>
                        <div class="weekday-selector">
                            <label class="weekday-item">
                                <input type="checkbox" value="1" onchange="updateSelectedWeekdays()">
                                <span>ä¸€</span>
                            </label>
                            <label class="weekday-item">
                                <input type="checkbox" value="2" onchange="updateSelectedWeekdays()">
                                <span>äºŒ</span>
                            </label>
                            <label class="weekday-item">
                                <input type="checkbox" value="3" onchange="updateSelectedWeekdays()">
                                <span>ä¸‰</span>
                            </label>
                            <label class="weekday-item">
                                <input type="checkbox" value="4" onchange="updateSelectedWeekdays()">
                                <span>å››</span>
                            </label>
                            <label class="weekday-item">
                                <input type="checkbox" value="5" onchange="updateSelectedWeekdays()">
                                <span>äº”</span>
                            </label>
                            <label class="weekday-item">
                                <input type="checkbox" value="6" onchange="updateSelectedWeekdays()">
                                <span>å…­</span>
                            </label>
                            <label class="weekday-item">
                                <input type="checkbox" value="0" onchange="updateSelectedWeekdays()">
                                <span>æ—¥</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group" id="monthlyConfig" style="display: none;">
                        <label>æ—¥æœŸ</label>
                        <div class="month-day-input">
                            <input type="number" id="monthDayInput" min="1" max="31" placeholder="è¼¸å…¥æ—¥æœŸ" onkeypress="if(event.key==='Enter') addMonthDay()">
                            <button type="button" onclick="addMonthDay()">æ–°å¢</button>
                        </div>
                        <div class="selected-days" id="selectedDaysDisplay"></div>
                    </div>
                    <div class="form-group">
                        <label>æ™‚é–“ç¯„åœ</label>
                        <div class="time-range">
                            <input type="time" id="scheduleStartTime" value="09:30">
                            <span>è‡³</span>
                            <input type="time" id="scheduleEndTime" value="17:30">
                        </div>
                    </div>
                </div>
            </div>

            <!-- å‹•ä½œé¡å‹é¸æ“‡ -->
            <div class="form-group">
                <label>æé†’å‹•ä½œï¼ˆå¯è¤‡é¸ï¼‰</label>
                <div class="action-types">
                    <label class="action-checkbox">
                        <input type="checkbox" id="voiceAction" checked onchange="toggleAction('voice')">
                        <span class="checkmark">ğŸ”Š èªéŸ³æé†’</span>
                    </label>
                    <label class="action-checkbox">
                        <input type="checkbox" id="linkAction" onchange="toggleAction('link')">
                        <span class="checkmark">ğŸ”— é–‹å•Ÿé€£çµ</span>
                    </label>
                </div>
            </div>

            <!-- èªéŸ³æé†’è¨­å®š -->
            <div id="voiceConfig" class="action-config active">
                <div class="form-group">
                    <label>èªéŸ³é¡å‹</label>
                    <select id="voiceType" onchange="updateVoiceConfig(); handleSettingChange(event);">
                        <option value="tts">æ–‡å­—è½‰èªéŸ³</option>
                        <option value="file">æœ¬åœ°éŸ³æª”</option>
                    </select>
                </div>
                <div class="form-group" id="ttsConfig">
                    <label>æç¤ºæ–‡å­—ï¼ˆæ¯è¡Œä¸€å€‹ï¼Œç³»çµ±æœƒéš¨æ©Ÿé¸æ“‡ï¼‰</label>
                    <textarea id="ttsTexts" placeholder="è©²ä¼‘æ¯ä¸€ä¸‹äº†ï¼&#10;è¨˜å¾—å–æ°´å“¦ï¼&#10;ç«™èµ·ä¾†æ´»å‹•ä¸€ä¸‹å§ï¼">è©²ä¼‘æ¯ä¸€ä¸‹äº†ï¼
è¨˜å¾—å–æ°´å“¦ï¼
ç«™èµ·ä¾†æ´»å‹•ä¸€ä¸‹å§ï¼</textarea>
                </div>
                <div class="form-group" id="fileConfig" style="display: none;">
                    <label>éŸ³æª”åˆ—è¡¨ï¼ˆç³»çµ±æœƒéš¨æ©Ÿé¸æ“‡ï¼‰</label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <input type="file" id="audioFileInput" accept="audio/*" style="flex: 1;">
                        <button type="button" onclick="addAudioFile()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            â• åŠ å…¥
                        </button>
                    </div>
                    <div id="audioFilesList" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- é–‹å•Ÿé€£çµè¨­å®š -->
            <div id="linkConfig" class="action-config">
                <div class="form-group">
                    <label>ç¶²å€åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€å€‹ï¼Œç³»çµ±æœƒéš¨æ©Ÿé¸æ“‡ï¼‰</label>
                    <textarea id="linkUrls" placeholder="https://www.google.com&#10;https://www.youtube.com&#10;https://github.com">https://www.google.com
https://www.youtube.com
https://github.com</textarea>
                </div>
            </div>


            <!-- æ’­æ”¾æ™‚é•·è¨­å®š -->
            <div class="form-group">
                <label>æ’­æ”¾æ™‚é•·</label>
                <div class="duration-config">
                    <input type="number" id="durationValue" min="1" value="5">
                    <select id="durationUnit">
                        <option value="seconds" selected>ç§’</option>
                        <option value="minutes">åˆ†é˜</option>
                        <option value="hours">å°æ™‚</option>
                    </select>
                </div>
            </div>

            <!-- é‡è¤‡è¨­å®š -->
            <div class="form-group">
                <label>
                    <input type="checkbox" id="isRepeating" checked>
                    é‡è¤‡åŸ·è¡Œ
                </label>
            </div>

            <!-- æ§åˆ¶æŒ‰éˆ• -->
            <div class="control-buttons">
                <button class="btn btn-success" id="startBtn" onclick="startReminder()">
                    <span class="status-indicator status-stopped"></span>
                    å•Ÿå‹•æé†’
                </button>
                <button class="btn btn-warning" id="pauseBtn" onclick="pauseReminder()" disabled>
                    æš«åœ
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopReminder()" disabled>
                    åœæ­¢
                </button>
                <button class="btn btn-primary" onclick="testReminder()">
                    æ¸¬è©¦æé†’
                </button>
            </div>

            <!-- æ—¥èªŒå€åŸŸ -->
            <div class="log-area" id="logArea">
                <div class="log-entry">ç³»çµ±å°±ç·’ï¼Œè«‹è¨­å®šæé†’åƒæ•¸</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let selectedModes = ['interval']; // ä½¿ç”¨é™£åˆ—æ”¯æŒå¤šå€‹æ¨¡å¼
        let selectedActions = ['voice']; // ä½¿ç”¨é™£åˆ—æ”¯æŒå¤šå€‹å‹•ä½œ
        let reminderState = 'stopped'; // stopped, running, paused
        let intervalTimerId = null; // é–“éš”æé†’çš„è¨ˆæ™‚å™¨
        let scheduleTimerId = null; // æ’ç¨‹æé†’çš„è¨ˆæ™‚å™¨
        let uiUpdateTimerId = null; // UIç‹€æ…‹æ›´æ–°è¨ˆæ™‚å™¨
        let lastIntervalExecution = 0; // è¨˜éŒ„ä¸Šæ¬¡é–“éš”æé†’åŸ·è¡Œæ™‚é–“
        let currentAudio = null;
        let reminderStartTime = null;
        let pausedTime = null;
        let selectedAudioFiles = []; // å„²å­˜é¸æ“‡çš„éŸ³æª”æ–‡ä»¶å°è±¡
        let audioFilesList = []; // å„²å­˜éŸ³æª”ä¿¡æ¯ï¼ˆç”¨æ–¼ä¿å­˜ï¼‰
        let selectedWeekdays = ['1']; // é¸ä¸­çš„æ˜ŸæœŸ
        let selectedMonthDays = ['1']; // é¸ä¸­çš„æ—¥æœŸ
        let timeoutId = null; // èªéŸ³æ’­æ”¾è¶…æ™‚ID
        let voicePlaybackState = {
            isPlaying: false,
            startTime: null,
            duration: 0,
            intervalId: null
        };

        // è¨­å®šä¿å­˜
        function saveSettings() {
            const settings = {
                reminderName: document.getElementById('reminderName').value,
                selectedModes: selectedModes,
                selectedActions: selectedActions,
                intervalValue: document.getElementById('intervalValue').value,
                intervalUnit: document.getElementById('intervalUnit').value,
                scheduleType: document.getElementById('scheduleType').value,
                selectedWeekdays: selectedWeekdays,
                selectedMonthDays: selectedMonthDays,
                scheduleStartTime: document.getElementById('scheduleStartTime').value,
                scheduleEndTime: document.getElementById('scheduleEndTime').value,
                voiceType: document.getElementById('voiceType').value,
                ttsTexts: document.getElementById('ttsTexts').value,
                linkUrls: document.getElementById('linkUrls').value,
                durationValue: document.getElementById('durationValue').value,
                durationUnit: document.getElementById('durationUnit').value,
                isRepeating: document.getElementById('isRepeating').checked,
                audioFilesList: audioFilesList
            };
            
            localStorage.setItem('reminderSettings', JSON.stringify(settings));
        }

        // è¨­å®šè¼‰å…¥
        function loadSettings() {
            const savedSettings = localStorage.getItem('reminderSettings');
            if (!savedSettings) return;
            
            try {
                const settings = JSON.parse(savedSettings);
                
                // è¼‰å…¥åŸºæœ¬è¨­å®š
                document.getElementById('reminderName').value = settings.reminderName || 'æ¯æ—¥æé†’';
                document.getElementById('intervalValue').value = settings.intervalValue || '30';
                document.getElementById('intervalUnit').value = settings.intervalUnit || 'minutes';
                document.getElementById('scheduleType').value = settings.scheduleType || 'weekly';
                selectedWeekdays = settings.selectedWeekdays || ['1'];
                selectedMonthDays = settings.selectedMonthDays || ['1'];
                
                // æ›´æ–°æ˜ŸæœŸå’Œæ—¥æœŸé¡¯ç¤º
                updateWeekdayCheckboxes();
                updateSelectedDaysDisplay();
                document.getElementById('scheduleStartTime').value = settings.scheduleStartTime || '09:30';
                document.getElementById('scheduleEndTime').value = settings.scheduleEndTime || '17:30';
                document.getElementById('voiceType').value = settings.voiceType || 'tts';
                document.getElementById('ttsTexts').value = settings.ttsTexts || 'è©²ä¼‘æ¯ä¸€ä¸‹äº†ï¼\nè¨˜å¾—å–æ°´å“¦ï¼\nç«™èµ·ä¾†æ´»å‹•ä¸€ä¸‹å§ï¼';
                document.getElementById('linkUrls').value = settings.linkUrls || 'https://www.google.com\nhttps://www.youtube.com\nhttps://github.com';
                
                // è¼‰å…¥éŸ³æª”åˆ—è¡¨
                if (settings.audioFilesList) {
                    audioFilesList = settings.audioFilesList;
                    renderAudioFilesList();
                    
                    // ç”±æ–¼ File å°è±¡ç„¡æ³•ä¿å­˜åˆ° localStorageï¼Œéœ€è¦æ¸…ç©ºä¸¦æç¤ºç”¨æˆ¶é‡æ–°é¸æ“‡
                    selectedAudioFiles = [];
                    if (audioFilesList.length > 0) {
                        addLog(`ç™¼ç¾ ${audioFilesList.length} å€‹éŸ³æª”è¨˜éŒ„ï¼Œä½†éœ€è¦é‡æ–°é¸æ“‡éŸ³æª”æ–‡ä»¶`, 'info');
                    }
                }
                
                // è¼‰å…¥æ‡‰ç”¨ç¨‹å¼é¡¯ç¤º
                document.getElementById('durationValue').value = settings.durationValue || '5';
                document.getElementById('durationUnit').value = settings.durationUnit || 'seconds';
                document.getElementById('isRepeating').checked = settings.isRepeating !== false;
                
                // è¼‰å…¥æ¨¡å¼å’Œå‹•ä½œ
                if (settings.selectedModes) {
                    selectedModes = settings.selectedModes;
                } else {
                    selectedModes = ['interval']; // é è¨­å•Ÿç”¨é–“éš”æé†’
                }
                updateModeCheckboxes();
                if (settings.selectedActions) {
                    selectedActions = settings.selectedActions;
                } else {
                    selectedActions = ['voice']; // é è¨­å•Ÿç”¨èªéŸ³æé†’
                }
                updateActionCheckboxes();
                
                // æ›´æ–°ç›¸é—œUI
                updateScheduleConfig();
                updateVoiceConfig();
                
                addLog('è¨­å®šå·²è¼‰å…¥');
            } catch (error) {
                addLog('è¼‰å…¥è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // æ¨¡å¼é¸æ“‡
        // æ¨¡å¼åˆ‡æ›ï¼ˆè¤‡é¸ï¼‰
        function toggleMode(mode) {
            const checkbox = document.getElementById(mode + 'ModeCheckbox');
            const oldModes = [...selectedModes];
            
            if (checkbox.checked) {
                if (!selectedModes.includes(mode)) {
                    selectedModes.push(mode);
                }
            } else {
                selectedModes = selectedModes.filter(m => m !== mode);
            }
            
            console.log('toggleMode called, selectedModes now:', selectedModes);
            updateModeConfigs();
            addLog(`è¨­å®šå·²æ›´æ–°ï¼š${checkbox.checked ? 'å•Ÿç”¨' : 'é—œé–‰'}${mode === 'interval' ? 'é–“éš”æé†’' : 'æ’ç¨‹æé†’'}æ¨¡å¼`, 'info');
            saveSettings();
            
            // å¦‚æœæé†’æ­£åœ¨é‹è¡Œï¼Œé‡æ–°å•Ÿå‹•ç›¸é—œæé†’
            if (reminderState === 'running' && JSON.stringify(oldModes) !== JSON.stringify(selectedModes)) {
                if (mode === 'interval') {
                    if (checkbox.checked) {
                        addLog('é–“éš”æé†’æ¨¡å¼å·²å•Ÿç”¨ï¼Œç«‹å³å•Ÿå‹•', 'info');
                        startIntervalReminder();
                    } else {
                        addLog('é–“éš”æé†’æ¨¡å¼å·²é—œé–‰ï¼Œåœæ­¢é–“éš”æé†’', 'info');
                        if (intervalTimerId) {
                            clearInterval(intervalTimerId);
                            intervalTimerId = null;
                        }
                    }
                } else if (mode === 'schedule') {
                    if (checkbox.checked) {
                        addLog('æ’ç¨‹æé†’æ¨¡å¼å·²å•Ÿç”¨ï¼Œç«‹å³å•Ÿå‹•', 'info');
                        startScheduleReminder();
                    } else {
                        addLog('æ’ç¨‹æé†’æ¨¡å¼å·²é—œé–‰ï¼Œåœæ­¢æ’ç¨‹æé†’', 'info');
                        if (scheduleTimerId) {
                            clearInterval(scheduleTimerId);
                            scheduleTimerId = null;
                        }
                        // å¦‚æœåŒæ™‚å•Ÿç”¨é–“éš”æé†’ï¼Œé‡æ–°å•Ÿå‹•ä»¥ç§»é™¤æ’ç¨‹ç¯„åœé™åˆ¶
                        if (selectedModes.includes('interval')) {
                            addLog('ç§»é™¤æ’ç¨‹ç¯„åœé™åˆ¶ï¼Œé‡æ–°å•Ÿå‹•é–“éš”æé†’', 'info');
                            restartIntervalReminder();
                        }
                    }
                }
            }
        }
        
        // æ›´æ–°æ¨¡å¼é…ç½®é¡¯ç¤º
        function updateModeConfigs() {
            // é–“éš”æé†’é…ç½®
            const intervalConfig = document.getElementById('intervalConfig');
            if (selectedModes.includes('interval')) {
                intervalConfig.style.display = 'block';
            } else {
                intervalConfig.style.display = 'none';
            }
            
            // æ’ç¨‹æé†’é…ç½®
            const scheduleConfig = document.getElementById('scheduleConfig');
            if (selectedModes.includes('schedule')) {
                scheduleConfig.style.display = 'block';
            } else {
                scheduleConfig.style.display = 'none';
            }
        }
        
        // æ›´æ–°æ¨¡å¼è¤‡é¸æ¡†ç‹€æ…‹
        function updateModeCheckboxes() {
            const intervalCheckbox = document.getElementById('intervalModeCheckbox');
            const scheduleCheckbox = document.getElementById('scheduleModeCheckbox');
            
            if (intervalCheckbox) {
                intervalCheckbox.checked = selectedModes.includes('interval');
            }
            if (scheduleCheckbox) {
                scheduleCheckbox.checked = selectedModes.includes('schedule');
            }
            
            console.log('updateModeCheckboxes called, selectedModes:', selectedModes);
            console.log('Checkbox states:', {
                interval: intervalCheckbox ? intervalCheckbox.checked : 'not found',
                schedule: scheduleCheckbox ? scheduleCheckbox.checked : 'not found'
            });
            
            updateModeConfigs();
        }

        // å‹•ä½œåˆ‡æ›ï¼ˆè¤‡é¸ï¼‰
        function toggleAction(action) {
            const checkbox = document.getElementById(action + 'Action');
            
            if (checkbox.checked) {
                if (!selectedActions.includes(action)) {
                    selectedActions.push(action);
                }
            } else {
                selectedActions = selectedActions.filter(a => a !== action);
            }
            
            updateActionConfigs();
            addLog(`è¨­å®šå·²æ›´æ–°ï¼š${checkbox.checked ? 'å•Ÿç”¨' : 'é—œé–‰'}${getActionName(action)}å‹•ä½œ`, 'info');
            saveSettings();
        }
        
        // æ›´æ–°å‹•ä½œé…ç½®é¡¯ç¤º
        function updateActionConfigs() {
            // èªéŸ³é…ç½®
            const voiceConfig = document.getElementById('voiceConfig');
            if (selectedActions.includes('voice')) {
                voiceConfig.style.display = 'block';
            } else {
                voiceConfig.style.display = 'none';
            }
            
            // é€£çµé…ç½®
            const linkConfig = document.getElementById('linkConfig');
            if (selectedActions.includes('link')) {
                linkConfig.style.display = 'block';
            } else {
                linkConfig.style.display = 'none';
            }
        }
        
        // æ›´æ–°å‹•ä½œè¤‡é¸æ¡†ç‹€æ…‹
        function updateActionCheckboxes() {
            document.getElementById('voiceAction').checked = selectedActions.includes('voice');
            document.getElementById('linkAction').checked = selectedActions.includes('link');
            updateActionConfigs();
        }
        
        // æ›´æ–°é¸ä¸­çš„æ˜ŸæœŸ
        function updateSelectedWeekdays() {
            const checkboxes = document.querySelectorAll('#weeklyConfig input[type="checkbox"]');
            const oldWeekdays = [...selectedWeekdays];
            selectedWeekdays = [];
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedWeekdays.push(cb.value);
                }
            });
            
            // è¨˜éŒ„è®Šæ›´
            if (JSON.stringify(oldWeekdays) !== JSON.stringify(selectedWeekdays)) {
                addLog(`è¨­å®šå·²æ›´æ–°ï¼šæ˜ŸæœŸé¸æ“‡ = ${getWeekdayNames(selectedWeekdays)}`, 'info');
            }
            
            saveSettings();
            
            // å¦‚æœæ’ç¨‹æé†’æ­£åœ¨é‹è¡Œï¼Œé‡æ–°å•Ÿå‹•
            if (reminderState === 'running' && selectedModes.includes('schedule')) {
                addLog('æ˜ŸæœŸè¨­å®šå·²è®Šæ›´ï¼Œé‡æ–°å•Ÿå‹•æ’ç¨‹æé†’', 'info');
                restartScheduleReminder();
            }
        }
        
        // æ–°å¢æœˆä»½æ—¥æœŸ
        function addMonthDay() {
            const input = document.getElementById('monthDayInput');
            const day = input.value.trim();
            
            if (!day || day < 1 || day > 31) {
                addLog('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸï¼ˆ1-31ï¼‰', 'error');
                return;
            }
            
            if (selectedMonthDays.includes(day)) {
                addLog('è©²æ—¥æœŸå·²å­˜åœ¨', 'error');
                return;
            }
            
            selectedMonthDays.push(day);
            selectedMonthDays.sort((a, b) => parseInt(a) - parseInt(b));
            
            input.value = '';
            updateSelectedDaysDisplay();
            addLog(`è¨­å®šå·²æ›´æ–°ï¼šæ–°å¢æ—¥æœŸ ${day}è™Ÿ`, 'info');
            saveSettings();
            
            // å¦‚æœæ’ç¨‹æé†’æ­£åœ¨é‹è¡Œï¼Œé‡æ–°å•Ÿå‹•
            if (reminderState === 'running' && selectedModes.includes('schedule')) {
                addLog('æ—¥æœŸè¨­å®šå·²è®Šæ›´ï¼Œé‡æ–°å•Ÿå‹•æ’ç¨‹æé†’', 'info');
                restartScheduleReminder();
            }
        }
        
        // ç§»é™¤æœˆä»½æ—¥æœŸ
        function removeMonthDay(day) {
            selectedMonthDays = selectedMonthDays.filter(d => d !== day);
            updateSelectedDaysDisplay();
            addLog(`è¨­å®šå·²æ›´æ–°ï¼šç§»é™¤æ—¥æœŸ ${day}è™Ÿ`, 'info');
            saveSettings();
            
            // å¦‚æœæ’ç¨‹æé†’æ­£åœ¨é‹è¡Œï¼Œé‡æ–°å•Ÿå‹•
            if (reminderState === 'running' && selectedModes.includes('schedule')) {
                addLog('æ—¥æœŸè¨­å®šå·²è®Šæ›´ï¼Œé‡æ–°å•Ÿå‹•æ’ç¨‹æé†’', 'info');
                restartScheduleReminder();
            }
        }
        
        // æ›´æ–°é¸ä¸­æ—¥æœŸé¡¯ç¤º
        function updateSelectedDaysDisplay() {
            const container = document.getElementById('selectedDaysDisplay');
            
            if (selectedMonthDays.length === 0) {
                container.innerHTML = '<div style="color: #666; font-size: 12px; text-align: center; padding: 10px;">å°šæœªé¸æ“‡æ—¥æœŸ</div>';
                return;
            }
            
            container.innerHTML = selectedMonthDays.map(day => `
                <div class="day-tag">
                    <span>${day}è™Ÿ</span>
                    <span class="remove-day" onclick="removeMonthDay('${day}')">Ã—</span>
                </div>
            `).join('');
        }
        
        // ç²å–æ˜ŸæœŸåç¨±
        function getWeekdayNames(weekdays) {
            const names = {
                '0': 'æ—¥',
                '1': 'ä¸€',
                '2': 'äºŒ', 
                '3': 'ä¸‰',
                '4': 'å››',
                '5': 'äº”',
                '6': 'å…­'
            };
            return 'æ˜ŸæœŸ' + weekdays.map(day => names[day]).join('ã€');
        }
        
        // æª¢æŸ¥ç•¶å‰æ™‚é–“æ˜¯å¦åœ¨æ’ç¨‹æ™‚é–“ç¯„åœå…§
        function isInScheduleTimeRange(logResult = false) {
            if (!selectedModes.includes('schedule')) {
                return false;
            }
            
            const scheduleType = document.getElementById('scheduleType').value;
            const scheduleStartTime = document.getElementById('scheduleStartTime').value;
            const scheduleEndTime = document.getElementById('scheduleEndTime').value;
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const [startHours, startMinutes] = scheduleStartTime.split(':').map(Number);
            const [endHours, endMinutes] = scheduleEndTime.split(':').map(Number);
            const startTime = startHours * 60 + startMinutes;
            const endTime = endHours * 60 + endMinutes;
            
            // æª¢æŸ¥æ˜¯å¦åœ¨æ™‚é–“ç¯„åœå…§
            let inTimeRange = false;
            if (endTime >= startTime) {
                // æ­£å¸¸æƒ…æ³ï¼ˆä¸è·¨æ—¥ï¼‰
                inTimeRange = currentTime >= startTime && currentTime <= endTime;
            } else {
                // è·¨æ—¥æƒ…æ³ï¼ˆä¾‹å¦‚æ™šä¸Š10é»åˆ°éš”å¤©æ—©ä¸Š6é»ï¼‰
                inTimeRange = currentTime >= startTime || currentTime <= endTime;
            }
            
            if (!inTimeRange) {
                if (logResult) {
                    addLog('é–“éš”æé†’è¢«æš«åœï¼šä¸åœ¨æ’ç¨‹æ™‚é–“ç¯„åœå…§', 'info');
                }
                return false;
            }
            
            // æª¢æŸ¥æ˜¯å¦ç¬¦åˆæ—¥æœŸæ¢ä»¶
            let matchesDateCondition = false;
            if (scheduleType === 'daily') {
                matchesDateCondition = true;
            } else if (scheduleType === 'weekly') {
                const currentWeekday = now.getDay().toString();
                matchesDateCondition = selectedWeekdays.includes(currentWeekday);
            } else if (scheduleType === 'monthly') {
                const currentMonthDay = now.getDate().toString();
                matchesDateCondition = selectedMonthDays.includes(currentMonthDay);
            }
            
            if (!matchesDateCondition && logResult) {
                addLog('é–“éš”æé†’è¢«æš«åœï¼šä¸ç¬¦åˆæ’ç¨‹æ—¥æœŸæ¢ä»¶', 'info');
            }
            
            return matchesDateCondition;
        }
        
        // æ›´æ–°æ˜ŸæœŸè¤‡é¸æ¡†ç‹€æ…‹
        function updateWeekdayCheckboxes() {
            const checkboxes = document.querySelectorAll('#weeklyConfig input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = selectedWeekdays.includes(cb.value);
            });
        }
        

        // æ·»åŠ éŸ³æª”
        function addAudioFile() {
            const fileInput = document.getElementById('audioFileInput');
            if (fileInput.files.length === 0) {
                addLog('è«‹å…ˆé¸æ“‡éŸ³æª”', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (audioFilesList.some(item => item.name === file.name && item.size === file.size)) {
                addLog('æ­¤éŸ³æª”å·²å­˜åœ¨æ–¼åˆ—è¡¨ä¸­', 'error');
                return;
            }
            
            // æ·»åŠ åˆ°åˆ—è¡¨
            const fileInfo = {
                name: file.name,
                size: file.size,
                type: file.type,
                id: Date.now()
            };
            
            audioFilesList.push(fileInfo);
            selectedAudioFiles.push(file);
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            fileInput.value = '';
            
            // æ›´æ–°é¡¯ç¤º
            renderAudioFilesList();
            saveSettings();
            addLog(`å·²æ·»åŠ éŸ³æª”ï¼š${file.name}`);
        }

        // æ¸²æŸ“éŸ³æª”åˆ—è¡¨
        function renderAudioFilesList() {
            const container = document.getElementById('audioFilesList');
            
            if (audioFilesList.length === 0) {
                container.innerHTML = '<div class="empty-list">å°šæœªæ·»åŠ ä»»ä½•éŸ³æª”</div>';
                return;
            }
            
            container.innerHTML = audioFilesList.map((file, index) => `
                <div class="file-item">
                    <span class="file-name">ğŸµ ${file.name}</span>
                    <button class="remove-btn" onclick="removeAudioFile(${index})" title="ç§»é™¤">Ã—</button>
                </div>
            `).join('');
        }

        // ç§»é™¤éŸ³æª”
        function removeAudioFile(index) {
            const fileName = audioFilesList[index].name;
            audioFilesList.splice(index, 1);
            selectedAudioFiles.splice(index, 1);
            
            renderAudioFilesList();
            saveSettings();
            addLog(`å·²ç§»é™¤éŸ³æª”ï¼š${fileName}`);
        }


        // æ›´æ–°æ’ç¨‹é…ç½®
        function updateScheduleConfig() {
            const type = document.getElementById('scheduleType').value;
            const weeklyConfig = document.getElementById('weeklyConfig');
            const monthlyConfig = document.getElementById('monthlyConfig');
            
            if (type === 'weekly') {
                weeklyConfig.style.display = 'block';
                monthlyConfig.style.display = 'none';
            } else if (type === 'monthly') {
                weeklyConfig.style.display = 'none';
                monthlyConfig.style.display = 'block';
            } else {
                weeklyConfig.style.display = 'none';
                monthlyConfig.style.display = 'none';
            }
            
            // æ­¤å‡½æ•¸åƒ…æ“ä½œ UIï¼Œå¯¦éš›å€¼çš„è®Šæ›´ç”± handleSettingChange è™•ç†
        }

        // æ›´æ–°èªéŸ³é…ç½®
        function updateVoiceConfig() {
            const type = document.getElementById('voiceType').value;
            const ttsConfig = document.getElementById('ttsConfig');
            const fileConfig = document.getElementById('fileConfig');
            
            if (type === 'tts') {
                ttsConfig.style.display = 'block';
                fileConfig.style.display = 'none';
            } else {
                ttsConfig.style.display = 'none';
                fileConfig.style.display = 'block';
            }
            
            // æ­¤å‡½æ•¸åƒ…æ“ä½œ UIï¼Œå¯¦éš›å€¼çš„è®Šæ›´ç”± handleSettingChange è™•ç†
        }

        // å•Ÿå‹•æé†’
        function startReminder() {
            console.log('startReminder called, current state:', reminderState);
            
            if (reminderState === 'paused') {
                resumeReminder();
                return;
            }
            
            const name = document.getElementById('reminderName').value || 'æé†’';
            
            reminderState = 'running';
            reminderStartTime = Date.now();
            console.log('Setting reminderState to running');
            
            // å•Ÿå‹•æ‰€æœ‰é¸ä¸­çš„æ¨¡å¼
            console.log('selectedModes:', selectedModes);
            selectedModes.forEach(mode => {
                console.log('Starting mode:', mode);
                if (mode === 'interval') {
                    startIntervalReminder();
                } else if (mode === 'schedule') {
                    startScheduleReminder();
                }
            });
            
            if (selectedModes.length === 0) {
                console.error('No modes selected!');
                addLog('éŒ¯èª¤ï¼šæ²’æœ‰é¸æ“‡ä»»ä½•æé†’æ¨¡å¼', 'error');
                return;
            }
            
            // å•Ÿå‹•UIç‹€æ…‹æ›´æ–°è¨ˆæ™‚å™¨
            uiUpdateTimerId = setInterval(updateUI, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡UIç‹€æ…‹
            updateUI();
            
            addLog(`é–‹å§‹åŸ·è¡Œæé†’ï¼š${name}`, 'success');
        }

        // æš«åœæé†’
        function pauseReminder() {
            reminderState = 'paused';
            pausedTime = Date.now();
            
            // æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
            if (intervalTimerId) {
                clearInterval(intervalTimerId);
                intervalTimerId = null;
            }
            if (scheduleTimerId) {
                clearInterval(scheduleTimerId);
                scheduleTimerId = null;
            }
            if (uiUpdateTimerId) {
                clearInterval(uiUpdateTimerId);
                uiUpdateTimerId = null;
            }
            
            stopCurrentAudio();
            updateUI();
            addLog('æé†’å·²æš«åœ', 'success');
        }

        // æ¢å¾©æé†’
        function resumeReminder() {
            reminderState = 'running';
            updateUI();
            
            // æ¢å¾©æ‰€æœ‰é¸ä¸­çš„æ¨¡å¼
            selectedModes.forEach(mode => {
                if (mode === 'interval') {
                    startIntervalReminder();
                } else if (mode === 'schedule') {
                    startScheduleReminder();
                }
            });
            
            addLog('æé†’å·²æ¢å¾©', 'success');
        }

        // åœæ­¢æé†’
        function stopReminder() {
            reminderState = 'stopped';
            
            // æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
            if (intervalTimerId) {
                clearInterval(intervalTimerId);
                intervalTimerId = null;
            }
            if (scheduleTimerId) {
                clearInterval(scheduleTimerId);
                scheduleTimerId = null;
            }
            if (uiUpdateTimerId) {
                clearInterval(uiUpdateTimerId);
                uiUpdateTimerId = null;
            }
            
            stopCurrentAudio();
            updateUI();
            addLog('æé†’å·²åœæ­¢', 'success');
        }

        // æ¸¬è©¦æé†’
        function testReminder() {
            addLog('åŸ·è¡Œæ¸¬è©¦æé†’...', 'success');
            
            // æª¢æŸ¥é¸ä¸­çš„å‹•ä½œ
            addLog(`é¸ä¸­çš„å‹•ä½œï¼š${selectedActions.join(', ')}`, 'info');
            
            // é¡¯ç¤ºç•¶å‰é–“éš”è¨­å®š
            const currentValue = parseInt(document.getElementById('intervalValue').value);
            const currentUnit = document.getElementById('intervalUnit').value;
            const currentMilliseconds = getIntervalInMs(currentValue, currentUnit);
            addLog(`ç•¶å‰é–“éš”è¨­å®šï¼šæ¯ ${currentValue} ${getUnitName(currentUnit)} (${currentMilliseconds}ms)`, 'info');
            
            // å¦‚æœåŒæ™‚å•Ÿç”¨äº†æ’ç¨‹æé†’ï¼Œæª¢æŸ¥æ™‚é–“ç¯„åœ
            if (selectedModes.includes('schedule')) {
                if (isInScheduleTimeRange(true)) {
                    executeReminder();
                } else {
                    addLog('æ¸¬è©¦æé†’è¢«æš«åœï¼šä¸åœ¨æ’ç¨‹æ™‚é–“ç¯„åœå…§', 'error');
                }
            } else {
                executeReminder();
            }
        }

        // é–“éš”æé†’
        function startIntervalReminder() {
            const value = parseInt(document.getElementById('intervalValue').value);
            const unit = document.getElementById('intervalUnit').value;
            
            let milliseconds = getIntervalInMs(value, unit);
            lastIntervalExecution = Date.now();
            
            // æ—¥èªŒè¨˜éŒ„è©³ç´°è¨­å®š
            console.log('startIntervalReminder:', { value, unit, milliseconds });
            addLog(`è®€å–é–“éš”è¨­å®šï¼š${value} ${getUnitName(unit)} = ${milliseconds}ms`, 'info');
            
            // å¦‚æœåŒæ™‚å•Ÿç”¨äº†æ’ç¨‹æé†’ï¼Œä½¿ç”¨è¼ƒå°çš„æª¢æŸ¥é–“éš”ä»¥ç¢ºä¿æ™‚é–“ç¯„åœæª¢æŸ¥æº–ç¢º
            // ä½†ä¸èƒ½å°æ–¼ 1 åˆ†é˜ï¼Œé¿å…éåº¦é »ç¹çš„æª¢æŸ¥
            const checkInterval = selectedModes.includes('schedule') ? 
                Math.min(milliseconds, 60000) : milliseconds;
            
            console.log('checkInterval:', checkInterval);
            addLog(`å¯¦éš›æª¢æŸ¥é–“éš”ï¼š${checkInterval}ms`, 'info');
            
            intervalTimerId = setInterval(() => {
                if (reminderState === 'running') {
                    const now = Date.now();
                    
                    // å¦‚æœåŒæ™‚å•Ÿç”¨äº†æ’ç¨‹æé†’ï¼Œå‰‡åªåœ¨æ’ç¨‹æ™‚é–“ç¯„åœå…§åŸ·è¡Œé–“éš”æé†’
                    if (selectedModes.includes('schedule')) {
                        // å‹•æ…‹è®€å–æœ€æ–°çš„é–“éš”è¨­å®š
                        const currentValue = parseInt(document.getElementById('intervalValue').value);
                        const currentUnit = document.getElementById('intervalUnit').value;
                        const currentMilliseconds = getIntervalInMs(currentValue, currentUnit);
                        
                        // æª¢æŸ¥æ˜¯å¦åœ¨æ’ç¨‹æ™‚é–“ç¯„åœå…§ä¸”é”åˆ°é–“éš”æ™‚é–“
                        if (isInScheduleTimeRange() && (now - lastIntervalExecution) >= currentMilliseconds) {
                            console.log('Executing reminder with current settings:', { currentValue, currentUnit, currentMilliseconds });
                            executeReminder();
                            lastIntervalExecution = now;
                        }
                    } else {
                        // åªæœ‰é–“éš”æé†’æ™‚ï¼Œæ­£å¸¸åŸ·è¡Œ
                        executeReminder();
                        lastIntervalExecution = now;
                    }
                }
            }, checkInterval);
            
            const scheduleNote = selectedModes.includes('schedule') ? 'ï¼ˆåƒ…åœ¨æ’ç¨‹æ™‚é–“ç¯„åœå…§åŸ·è¡Œï¼‰' : '';
            addLog(`é–“éš”æé†’å·²è¨­å®šï¼šæ¯ ${value} ${getUnitName(unit)}${scheduleNote}`);
        }

        // è¨ˆç®—é–“éš”æ¯«ç§’æ•¸
        function getIntervalInMs(value, unit) {
            const multipliers = {
                'minutes': 60 * 1000,
                'hours': 60 * 60 * 1000,
                'days': 24 * 60 * 60 * 1000,
                'weeks': 7 * 24 * 60 * 60 * 1000,
                'months': 30 * 24 * 60 * 60 * 1000 // è¿‘ä¼¼30å¤©
            };
            
            return value * (multipliers[unit] || 60000); // é è¨­åˆ†é˜
        }

        // æ’ç¨‹æé†’
        function startScheduleReminder() {
            const checkSchedule = () => {
                if (reminderState !== 'running') return;
                
                // ä½¿ç”¨çµ±ä¸€çš„æ™‚é–“ç¯„åœæª¢æŸ¥å‡½æ•¸
                if (isInScheduleTimeRange()) {
                    executeReminder();
                }
            };
            
            // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
            scheduleTimerId = setInterval(checkSchedule, 60000);
            
            addLog(`æ’ç¨‹æé†’å·²è¨­å®šï¼š${getScheduleDescription()}`);
        }

        // åŸ·è¡Œæé†’
        function executeReminder() {
            addLog('åŸ·è¡Œæé†’å‹•ä½œ...', 'success');
            
            // åŸ·è¡Œæ‰€æœ‰é¸ä¸­çš„å‹•ä½œ
            selectedActions.forEach(action => {
                if (action === 'voice') {
                    executeVoiceReminder();
                } else if (action === 'link') {
                    executeLinkReminder();
                }
            });
        }

        // èªéŸ³æé†’
        function executeVoiceReminder() {
            const voiceType = document.getElementById('voiceType').value;
            
            if (voiceType === 'tts') {
                const texts = document.getElementById('ttsTexts').value.split('\n').filter(t => t.trim());
                if (texts.length === 0) {
                    addLog('æ²’æœ‰è¨­å®šæç¤ºæ–‡å­—', 'error');
                    return;
                }
                
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´èªéŸ³åˆæˆAPI
                if (!('speechSynthesis' in window)) {
                    addLog('ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆåŠŸèƒ½', 'error');
                    return;
                }
                
                const randomText = texts[Math.floor(Math.random() * texts.length)];
                speakText(randomText);
                addLog(`èªéŸ³æé†’ï¼š${randomText}`);
            } else {
                if (selectedAudioFiles.length === 0) {
                    if (audioFilesList.length > 0) {
                        addLog('éœ€è¦é‡æ–°é¸æ“‡éŸ³æª”æ–‡ä»¶ï¼ˆé é¢é‡æ–°è¼‰å…¥å¾Œéœ€è¦é‡æ–°é¸æ“‡ï¼‰', 'error');
                    } else {
                        addLog('æ²’æœ‰é¸æ“‡éŸ³æª”', 'error');
                    }
                    return;
                }
                
                const randomFile = selectedAudioFiles[Math.floor(Math.random() * selectedAudioFiles.length)];
                playAudioFile(randomFile);
                addLog(`æ’­æ”¾éŸ³æª”ï¼š${randomFile.name}ï¼ˆå¾${selectedAudioFiles.length}å€‹éŸ³æª”ä¸­éš¨æ©Ÿé¸æ“‡ï¼‰`);
            }
        }

        // é€£çµæé†’
        function executeLinkReminder() {
            const urls = document.getElementById('linkUrls').value.split('\n').filter(u => u.trim());
            if (urls.length === 0) {
                addLog('æ²’æœ‰è¨­å®šç¶²å€', 'error');
                return;
            }
            
            const randomUrl = urls[Math.floor(Math.random() * urls.length)];
            window.open(randomUrl, '_blank');
            addLog(`é–‹å•Ÿé€£çµï¼š${randomUrl}`);
        }


        // æ–‡å­—è½‰èªéŸ³ - é€£çºŒé‡è¤‡æ’­æ”¾
        function speakText(text) {
            console.log('speakText called with:', text);
            addLog(`é–‹å§‹èªéŸ³æ’­æ”¾ï¼š${text}`, 'info');
            
            stopCurrentAudio();
            
            const duration = getDurationInMs();
            console.log('Duration:', duration);
            voicePlaybackState.isPlaying = true;
            voicePlaybackState.startTime = Date.now();
            voicePlaybackState.duration = duration;
            
            const playVoice = () => {
                if (!voicePlaybackState.isPlaying) return;
                
                const elapsed = Date.now() - voicePlaybackState.startTime;
                if (elapsed >= duration) {
                    stopCurrentAudio();
                    return;
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                utterance.onstart = () => {
                    console.log('Speech started');
                    addLog(`èªéŸ³æ’­æ”¾é–‹å§‹ï¼š${text}`, 'success');
                };
                
                utterance.onend = () => {
                    console.log('Speech ended');
                    addLog(`èªéŸ³æ’­æ”¾çµæŸï¼š${text}`, 'success');
                    if (voicePlaybackState.isPlaying && Date.now() - voicePlaybackState.startTime < duration) {
                        // çŸ­æš«åœé “å¾Œç¹¼çºŒæ’­æ”¾
                        setTimeout(playVoice, 200);
                    }
                };
                
                utterance.onerror = (error) => {
                    console.error('Speech error:', error);
                    addLog(`èªéŸ³æ’­æ”¾éŒ¯èª¤ï¼š${error.error}`, 'error');
                };
                
                console.log('Calling speechSynthesis.speak');
                speechSynthesis.speak(utterance);
            };
            
            playVoice();
            
            // è¨­å®šç¸½æ’­æ”¾æ™‚é•·é™åˆ¶
            timeoutId = setTimeout(() => {
                stopCurrentAudio();
            }, duration);
        }

        // æ’­æ”¾éŸ³æª” - é€£çºŒé‡è¤‡æ’­æ”¾
        function playAudioFile(file) {
            stopCurrentAudio();
            
            const url = URL.createObjectURL(file);
            const duration = getDurationInMs();
            voicePlaybackState.isPlaying = true;
            voicePlaybackState.startTime = Date.now();
            voicePlaybackState.duration = duration;
            
            const playAudio = () => {
                if (!voicePlaybackState.isPlaying) return;
                
                const elapsed = Date.now() - voicePlaybackState.startTime;
                if (elapsed >= duration) {
                    stopCurrentAudio();
                    URL.revokeObjectURL(url);
                    return;
                }
                
                currentAudio = new Audio(url);
                currentAudio.onended = () => {
                    if (voicePlaybackState.isPlaying && Date.now() - voicePlaybackState.startTime < duration) {
                        // çŸ­æš«åœé “å¾Œç¹¼çºŒæ’­æ”¾
                        setTimeout(playAudio, 200);
                    }
                };
                
                currentAudio.onerror = (error) => {
                    addLog(`éŸ³æª”è¼‰å…¥éŒ¯èª¤ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                };
                
                currentAudio.play().catch(error => {
                    addLog(`éŸ³æª”æ’­æ”¾éŒ¯èª¤ï¼š${error.message}`, 'error');
                    console.log('Audio play error:', error);
                });
            };
            
            playAudio();
            
            // è¨­å®šç¸½æ’­æ”¾æ™‚é•·é™åˆ¶
            timeoutId = setTimeout(() => {
                stopCurrentAudio();
                URL.revokeObjectURL(url);
            }, duration);
        }

        // åœæ­¢ç•¶å‰éŸ³è¨Š
        function stopCurrentAudio() {
            voicePlaybackState.isPlaying = false;
            
            if (currentAudio) {
                try {
                    // åªæœ‰åœ¨éŸ³æª”å¯ä»¥æš«åœæ™‚æ‰æš«åœ
                    if (currentAudio.readyState >= 2) { // HAVE_CURRENT_DATA
                        currentAudio.pause();
                    }
                } catch (error) {
                    console.log('Stop audio error (å¯å¿½ç•¥):', error.message);
                }
                currentAudio = null;
            }
            
            try {
                speechSynthesis.cancel();
            } catch (error) {
                console.log('Stop speech synthesis error (å¯å¿½ç•¥):', error.message);
            }
            
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
            
            if (voicePlaybackState.intervalId) {
                clearInterval(voicePlaybackState.intervalId);
                voicePlaybackState.intervalId = null;
            }
        }

        // ç²å–æ’­æ”¾æ™‚é•·ï¼ˆæ¯«ç§’ï¼‰
        function getDurationInMs() {
            const value = parseInt(document.getElementById('durationValue').value);
            const unit = document.getElementById('durationUnit').value;
            
            const multipliers = {
                'seconds': 1000,
                'minutes': 60 * 1000,
                'hours': 60 * 60 * 1000
            };
            
            return value * (multipliers[unit] || 1000); // é è¨­ç§’
        }

        // æ›´æ–°UIç‹€æ…‹
        function updateUI() {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            // ç¢ºä¿æŒ‰éˆ•å…ƒç´ å­˜åœ¨
            if (!startBtn || !pauseBtn || !stopBtn) {
                console.error('ç„¡æ³•æ‰¾åˆ°æŒ‰éˆ•å…ƒç´ ');
                return;
            }
            
            console.log('updateUI called, reminderState:', reminderState);
            
            // ç²å–æˆ–å‰µå»ºç‹€æ…‹æŒ‡ç¤ºå™¨
            let indicator = startBtn.querySelector('.status-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'status-indicator';
                startBtn.insertBefore(indicator, startBtn.firstChild);
            }
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            if (reminderState === 'stopped') {
                indicator.className = 'status-indicator status-stopped';
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                console.log('UI set to stopped state, startBtn.disabled:', startBtn.disabled);
            } else if (reminderState === 'running') {
                indicator.className = 'status-indicator status-running';
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
            } else if (reminderState === 'paused') {
                indicator.className = 'status-indicator status-paused';
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = false;
            }
            
            console.log('Button states after update:', {
                startBtn: { disabled: startBtn.disabled, onclick: !!startBtn.onclick },
                pauseBtn: { disabled: pauseBtn.disabled, onclick: !!pauseBtn.onclick },
                stopBtn: { disabled: stopBtn.disabled, onclick: !!stopBtn.onclick }
            });
        }

        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            
            // ä¿æŒæœ€å¤š100æ¢è¨˜éŒ„
            while (logArea.children.length > 100) {
                logArea.removeChild(logArea.firstChild);
            }
        }

        // è¼”åŠ©å‡½æ•¸
        function getActionName(action) {
            const names = {
                'voice': 'èªéŸ³æé†’',
                'link': 'é–‹å•Ÿé€£çµ'
            };
            return names[action] || action;
        }

        function getUnitName(unit) {
            const names = {
                'seconds': 'ç§’',
                'minutes': 'åˆ†é˜',
                'hours': 'å°æ™‚',
                'days': 'å¤©',
                'weeks': 'é€±',
                'months': 'æœˆ'
            };
            return names[unit] || unit;
        }

        function getScheduleDescription() {
            const scheduleType = document.getElementById('scheduleType').value;
            const scheduleStartTime = document.getElementById('scheduleStartTime').value;
            const scheduleEndTime = document.getElementById('scheduleEndTime').value;
            const timeRange = `${scheduleStartTime}-${scheduleEndTime}`;
            
            if (scheduleType === 'daily') {
                return `æ¯å¤© ${timeRange}`;
            } else if (scheduleType === 'weekly') {
                const weekDayNames = getWeekdayNames(selectedWeekdays);
                return `æ¯é€±${weekDayNames} ${timeRange}`;
            } else if (scheduleType === 'monthly') {
                const monthDayNames = selectedMonthDays.join('ã€') + 'è™Ÿ';
                return `æ¯æœˆ${monthDayNames} ${timeRange}`;
            }
        }


        // ç‚ºæ‰€æœ‰è¼¸å…¥æ¡†æ·»åŠ è‡ªå‹•ä¿å­˜å’Œå³æ™‚æ›´æ–°
        function initializeAutoSave() {
            const inputs = document.querySelectorAll('input, select, textarea');
            console.log('Found inputs for auto-save:', inputs.length);
            inputs.forEach((input, index) => {
                console.log(`Input ${index}: id=${input.id}, type=${input.type || input.tagName}`);
                input.addEventListener('change', handleSettingChange);
                input.addEventListener('input', handleSettingChange);
            });
            
        }
        
        // è™•ç†è¨­å®šè®Šæ›´
        function handleSettingChange(event) {
            const element = event.target;
            const fieldName = element.id || element.name;
            const oldValue = element.dataset.oldValue || '';
            const newValue = element.type === 'checkbox' ? element.checked : element.value;
            
            console.log('handleSettingChange:', { 
                fieldName, 
                oldValue, 
                newValue, 
                reminderState,
                elementId: element.id,
                elementTagName: element.tagName
            });
            
            // å¦‚æœæ²’æœ‰fieldNameï¼Œè·³éè™•ç†
            if (!fieldName) {
                console.log('No fieldName found, skipping');
                return;
            }
            
            // è¨˜éŒ„è¨­å®šè®Šæ›´
            if (oldValue !== newValue.toString()) {
                const fieldDisplayName = getFieldDisplayName(fieldName);
                addLog(`è¨­å®šå·²æ›´æ–°ï¼š${fieldDisplayName} = ${formatValue(newValue)}`, 'info');
                
                // æ›´æ–°èˆŠå€¼
                element.dataset.oldValue = newValue.toString();
            }
            
            // ä¿å­˜è¨­å®š
            saveSettings();
            
            // å¦‚æœæ˜¯é—œéµè¨­å®šä¸”æé†’æ­£åœ¨é‹è¡Œï¼Œé‡æ–°å•Ÿå‹•ç›¸é—œæé†’
            if (reminderState === 'running') {
                console.log('Reminder is running, checking if restart needed for field:', fieldName);
                restartActiveReminders(fieldName);
            }
        }
        
        // é‡æ–°å•Ÿå‹•ç›¸é—œçš„æé†’
        function restartActiveReminders(changedField) {
            const intervalRelatedFields = ['intervalValue', 'intervalUnit'];
            const scheduleRelatedFields = ['scheduleType', 'scheduleStartTime', 'scheduleEndTime'];
            
            console.log('restartActiveReminders:', { 
                changedField, 
                intervalRelatedFields, 
                scheduleRelatedFields, 
                selectedModes 
            });
            
            if (intervalRelatedFields.includes(changedField) && selectedModes.includes('interval')) {
                addLog('é–“éš”è¨­å®šå·²è®Šæ›´ï¼Œé‡æ–°å•Ÿå‹•é–“éš”æé†’', 'info');
                restartIntervalReminder();
            }
            
            if (scheduleRelatedFields.includes(changedField) && selectedModes.includes('schedule')) {
                addLog('æ’ç¨‹è¨­å®šå·²è®Šæ›´ï¼Œé‡æ–°å•Ÿå‹•æ’ç¨‹æé†’', 'info');
                restartScheduleReminder();
            }
        }
        
        // é‡æ–°å•Ÿå‹•é–“éš”æé†’
        function restartIntervalReminder() {
            console.log('restartIntervalReminder called');
            addLog('æ­£åœ¨é‡æ–°å•Ÿå‹•é–“éš”æé†’...', 'info');
            
            // åœæ­¢ç¾æœ‰çš„é–“éš”æé†’
            if (intervalTimerId) {
                clearInterval(intervalTimerId);
                intervalTimerId = null;
                addLog('å·²åœæ­¢èˆŠçš„é–“éš”æé†’', 'info');
            }
            
            // é‡ç½®æœ€å¾ŒåŸ·è¡Œæ™‚é–“ï¼Œç¢ºä¿æ–°è¨­å®šç«‹å³ç”Ÿæ•ˆ
            lastIntervalExecution = 0;
            
            // é‡æ–°å•Ÿå‹•é–“éš”æé†’
            if (selectedModes.includes('interval')) {
                addLog('ä½¿ç”¨æ–°è¨­å®šå•Ÿå‹•é–“éš”æé†’', 'info');
                startIntervalReminder();
            } else {
                addLog('é–“éš”æ¨¡å¼æœªå•Ÿç”¨ï¼Œä¸å•Ÿå‹•é–“éš”æé†’', 'info');
            }
        }
        
        // é‡æ–°å•Ÿå‹•æ’ç¨‹æé†’
        function restartScheduleReminder() {
            // åœæ­¢ç¾æœ‰çš„æ’ç¨‹æé†’
            if (scheduleTimerId) {
                clearInterval(scheduleTimerId);
                scheduleTimerId = null;
            }
            
            // é‡æ–°å•Ÿå‹•æ’ç¨‹æé†’
            if (selectedModes.includes('schedule')) {
                startScheduleReminder();
            }
        }
        
        // ç²å–æ¬„ä½é¡¯ç¤ºåç¨±
        function getFieldDisplayName(fieldName) {
            const fieldNames = {
                'intervalValue': 'é–“éš”æ•¸å€¼',
                'intervalUnit': 'é–“éš”å–®ä½',
                'scheduleType': 'æ’ç¨‹é¡å‹',
                'scheduleStartTime': 'æ’ç¨‹é–‹å§‹æ™‚é–“',
                'scheduleEndTime': 'æ’ç¨‹çµæŸæ™‚é–“',
                'reminderName': 'æé†’åç¨±',
                'voiceType': 'èªéŸ³é¡å‹',
                'ttsTexts': 'æç¤ºæ–‡å­—',
                'linkUrls': 'é€£çµæ¸…å–®',
                'durationValue': 'æ’­æ”¾æ™‚é•·æ•¸å€¼',
                'durationUnit': 'æ’­æ”¾æ™‚é•·å–®ä½',
                'isRepeating': 'é‡è¤‡åŸ·è¡Œ',
                'monthDayInput': 'æœˆä»½æ—¥æœŸè¼¸å…¥'
            };
            return fieldNames[fieldName] || fieldName;
        }
        
        // æ ¼å¼åŒ–å€¼é¡¯ç¤º
        function formatValue(value) {
            if (typeof value === 'boolean') {
                return value ? 'æ˜¯' : 'å¦';
            }
            if (typeof value === 'string' && value.includes('\n')) {
                return `å¤šè¡Œå…§å®¹ï¼ˆ${value.split('\n').length}è¡Œï¼‰`;
            }
            return value;
        }
        
        // åˆå§‹åŒ–æ¬„ä½èˆŠå€¼
        function initializeFieldOldValues() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const value = input.type === 'checkbox' ? input.checked : input.value;
                input.dataset.oldValue = value.toString();
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('Page loaded, initializing...');
            
            loadSettings(); // è¼‰å…¥ä¿å­˜çš„è¨­å®š
            initializeAutoSave();
            initializeFieldOldValues(); // åˆå§‹åŒ–æ¬„ä½èˆŠå€¼
            
            // æª¢æŸ¥æŒ‰éˆ•æ˜¯å¦å·²ç¶“æœ‰ onclick äº‹ä»¶
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            console.log('Button onclick events check:', {
                startBtn: !!startBtn.onclick,
                pauseBtn: !!pauseBtn.onclick,
                stopBtn: !!stopBtn.onclick
            });
            
            // ç¢ºä¿åœ¨è¨­å®šäº‹ä»¶å¾Œå†æ›´æ–°UI
            updateUI();
            addLog('æé†’æ¨¡çµ„å·²è¼‰å…¥');
            addLog('âœ… è¨­å®šè®Šæ›´æç¤ºå·²å•Ÿç”¨ï¼šè®Šæ›´è¨­å®šæ™‚å°‡ç«‹å³ä¿å­˜ä¸¦é‡æ–°å•Ÿå‹•ç›¸é—œæé†’', 'info');
        });

        // é é¢é—œé–‰æ™‚æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopReminder();
        });
    </script>
</body>
</html>